<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hearth Gallery</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Custom Styles and Animations -->
    <style>
        :root {
            --bg-main: #F4E9D8; /* A warmer, cozier beige */
            --bg-secondary: #FFFFFF;
            --text-main: #5C4033; /* Dark Brown */
            --text-secondary: #8A6652; /* Lighter brown */
            --primary-accent: #E57A44; /* Burnt Sienna/Orange */
            --primary-accent-dark: #D46A34;
            --border-color: #DCD0C0; /* Warm gray/beige */
            --shadow-sm: rgba(92, 64, 51, 0.05);
            --shadow-md: rgba(92, 64, 51, 0.1);
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
        }

        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
        }

        /* Cozy Button Style */
        .btn-cozy {
            @apply px-6 py-2.5 rounded-full text-white font-semibold transition-all duration-300 ease-in-out shadow-md;
            background-image: linear-gradient(to right, var(--primary-accent), #ff9a63);
            background-size: 200% auto;
        }

        .btn-cozy:hover {
            background-position: right center;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--shadow-md);
        }
        
        /* Smooth animations */
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Modal transitions */
        .modal-enter { animation: modal-in 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .modal-leave { animation: modal-out 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }

        @keyframes modal-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes modal-out {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }

        /* Shimmering placeholder */
        .placeholder-card {
            background: linear-gradient(-90deg, #f5efe6 0%, #ffffff 50%, #f5efe6 100%);
            background-size: 400% 400%;
            animation: shimmer 1.2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { background-position: 0% 0%; }
            100% { background-position: -135% 0%; }
        }

        /* Masonry Grid for Gallery */
        #gallery-grid {
            column-gap: 1.5rem;
        }
        
        @media (min-width: 640px) { #gallery-grid { column-count: 2; } }
        @media (min-width: 1024px) { #gallery-grid { column-count: 3; } }
        @media (min-width: 1280px) { #gallery-grid { column-count: 4; } }

        .gallery-item {
            @apply mb-6 break-inside-avoid;
        }

        .gallery-card {
            @apply bg-white rounded-lg shadow-sm transition-all duration-300 ease-in-out overflow-hidden;
        }
        .gallery-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px var(--shadow-md);
        }
        
        /* Rich Text Editor */
        .rich-text-editor {
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background-color: var(--bg-secondary);
        }
        .editor-toolbar {
            border-bottom: 1px solid var(--border-color);
            padding: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .toolbar-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 9999px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .toolbar-btn:hover, .toolbar-btn.is-active {
            background-color: #f5efe6;
        }
        #editor-content {
            padding: 1rem;
            min-height: 200px;
            outline: none;
        }
    </style>
</head>

<body class="antialiased">

    <!-- Auth Header -->
    <div id="auth-container" class="absolute top-4 right-4 z-20">
        <!-- Logged out state -->
        <div id="logged-out-view">
            <button id="login-btn" class="px-4 py-2 text-sm font-semibold rounded-full hover:bg-white transition">Login</button>
            <button id="signup-btn" class="px-4 py-2 text-sm font-semibold rounded-full btn-cozy ml-2">Sign Up</button>
        </div>
        <!-- Logged in state -->
        <div id="logged-in-view" class="hidden items-center">
            <span id="welcome-message" class="mr-4 font-semibold"></span>
            <button id="logout-btn" class="px-4 py-2 text-sm font-semibold rounded-full bg-white shadow-sm hover:bg-gray-100 transition">Logout</button>
        </div>
    </div>

    <!-- Main Container -->
    <div id="app" class="container mx-auto px-4 py-8 pt-20">

        <!-- Header -->
        <header class="text-center mb-12 fade-in-up">
            <h1 class="text-6xl font-bold mb-2" style="color: var(--text-main);">The Hearth Gallery</h1>
            <p class="text-xl" style="color: var(--text-secondary);">A cozy space for creators to share their spark.</p>
        </header>

        <!-- Action Bar Section -->
        <div class="mb-12 p-8 rounded-lg bg-white shadow-md text-center fade-in-up" style="animation-delay: 0.1s;">
            <h2 class="text-3xl font-bold mb-4">Share something new</h2>
            <p class="mb-6 max-w-xl mx-auto" style="color: var(--text-secondary);">What masterpiece are you bringing to the gallery today?</p>
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                <div class="relative w-full sm:w-1/2 lg:w-1/3">
                    <input id="search-bar" type="text" placeholder="Search the gallery..." class="w-full py-3 px-4 rounded-full border focus:outline-none focus:ring-2 transition" style="border-color: var(--border-color); background-color: var(--bg-main); color: var(--text-main); --tw-ring-color: var(--primary-accent);">
                    <i class="fa-solid fa-search absolute right-5 top-3.5" style="color: var(--text-secondary);"></i>
                </div>
                <button id="start-upload-btn" class="btn-cozy w-full sm:w-auto">
                    <i class="fa-solid fa-plus mr-2"></i> Start Upload
                </button>
            </div>
            <p id="upload-prompt" class="text-sm mt-3 hidden" style="color: var(--text-secondary);">Please log in to upload your art.</p>
        </div>
        
        <!-- App-wide Error Message -->
        <div id="app-error" class="mb-6 p-4 rounded-lg bg-red-100 text-red-700 text-center hidden"></div>

        <!-- Filters and Tag Cloud Section -->
        <div class="mb-12 fade-in-up" style="animation-delay: 0.2s;">
            <div id="category-filters" class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-6">
                 <!-- Category filters will be populated by JS -->
            </div>
             <div id="tag-cloud-container" class="text-center p-6 rounded-lg bg-white shadow-sm">
                <h3 class="text-lg font-bold mb-4" style="font-family: 'Inter', sans-serif;">Trending Tags</h3>
                <div id="tag-cloud" class="flex flex-wrap justify-center items-center gap-2">
                    <!-- Tags will be populated by JS -->
                </div>
            </div>
        </div>


        <!-- Gallery Grid -->
        <main id="gallery-grid">
            <!-- Placeholder cards will be injected by JS -->
        </main>
        
        <!-- Empty State Message -->
        <div id="empty-state" class="text-center py-20 hidden">
             <h2 class="text-3xl font-bold mb-4">The gallery is quiet...</h2>
             <p class="text-lg" style="color: var(--text-secondary);">Why not be the first to share something beautiful?</p>
        </div>

    </div>

    <!-- Upload Modal -->
    <div id="upload-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div id="upload-modal-content" class="modal-content rounded-lg p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto" style="background-color: var(--bg-main);">
            <h2 class="text-3xl font-bold mb-6 text-center">Share Your Creation</h2>
            <form id="upload-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="title" class="block font-bold mb-2">Title *</label>
                        <input type="text" id="title" class="w-full p-2 px-4 rounded-full border" style="border-color: var(--border-color); background-color: var(--bg-secondary);" required>
                    </div>
                    <div class="mb-4">
                        <label for="category" class="block font-bold mb-2">Category *</label>
                        <select id="category" class="w-full p-2 px-4 rounded-full border appearance-none" style="border-color: var(--border-color); background-color: var(--bg-secondary);" required>
                            <option value="Visual Art">Visual Art</option>
                            <option value="Photography">Photography</option>
                            <option value="Musical Score">Musical Score</option>
                            <option value="Written Word">Written Word</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="tags" class="block font-bold mb-2">Tags (comma separated)</label>
                    <input type="text" id="tags" placeholder="e.g. oil painting, abstract, nature" class="w-full p-2 px-4 rounded-full border" style="border-color: var(--border-color); background-color: var(--bg-secondary);">
                </div>

                <div id="file-upload-section" class="mb-4">
                    <label for="artwork-file" class="block font-bold mb-2">Upload File (Image or PDF)</label>
                    <input type="file" id="artwork-file" accept="image/*,application/pdf" class="w-full text-sm p-2 rounded-full border file:rounded-full file:border-0 file:bg-gray-100 file:mr-4 file:py-2 file:px-4 file:text-sm file:font-semibold" style="border-color: var(--border-color); background-color: var(--bg-secondary);">
                </div>
                
                 <div id="write-section" class="mb-4 hidden">
                    <label class="block font-bold mb-2">Write your piece here</label>
                    <div class="rich-text-editor">
                        <div class="editor-toolbar">
                            <button type="button" class="toolbar-btn" data-command="bold"><i class="fas fa-bold"></i></button>
                            <button type="button" class="toolbar-btn" data-command="italic"><i class="fas fa-italic"></i></button>
                            <button type="button" class="toolbar-btn" data-command="underline"><i class="fas fa-underline"></i></button>
                            <button type="button" class="toolbar-btn" data-command="strikeThrough"><i class="fas fa-strikethrough"></i></button>
                            <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="H2">H2</button>
                            <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="H3">H3</button>
                            <button type="button" class="toolbar-btn" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                            <button type="button" class="toolbar-btn" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                        </div>
                        <div id="editor-content" contenteditable="true"></div>
                    </div>
                </div>

                <div class="mt-6 mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="is-mature" class="h-5 w-5 rounded mr-3" style="accent-color: var(--primary-accent);">
                        <span>This work is intended for a mature audience.</span>
                    </label>
                </div>

                <div id="upload-error" class="text-red-500 text-center mb-4"></div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="cancel-upload" class="px-6 py-2 rounded-full text-gray-700 bg-gray-200 hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" id="submit-upload" class="btn-cozy">Publish</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Artwork Detail Modal -->
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
         <div id="detail-modal-content" class="modal-content relative bg-white rounded-lg w-full max-w-4xl max-h-[90vh] flex flex-col" style="background-color: var(--bg-secondary);">
             <button id="close-detail-modal" class="absolute -top-4 -right-4 bg-white rounded-full p-2 shadow-lg z-10 hover:scale-110 transition">
                 <svg class="w-6 h-6" style="color: var(--text-main);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
             </button>
             <div id="detail-content-area" class="overflow-y-auto p-8">
                 <!-- Detailed content will be populated here -->
             </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content rounded-lg p-8 w-full max-w-sm" style="background-color: var(--bg-main);">
            <h2 class="text-3xl font-bold mb-6 text-center">Login</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block font-bold mb-2">Email</label>
                    <input type="email" id="login-email" class="w-full p-2 px-4 rounded-full border" style="border-color: var(--border-color); background-color: var(--bg-secondary);" required>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block font-bold mb-2">Password</label>
                    <input type="password" id="login-password" class="w-full p-2 px-4 rounded-full border" style="border-color: var(--border-color); background-color: var(--bg-secondary);" required>
                </div>
                <div id="login-error" class="text-red-500 text-center mb-4 text-sm"></div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" class="btn-cancel px-6 py-2 rounded-full text-gray-700 bg-gray-200 hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="btn-cozy">Login</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Sign Up Modal -->
    <div id="signup-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content rounded-lg p-8 w-full max-w-sm" style="background-color: var(--bg-main);">
            <h2 class="text-3xl font-bold mb-6 text-center">Create Account</h2>
            <form id="signup-form">
                <div class="mb-4">
                    <label for="signup-email" class="block font-bold mb-2">Email</label>
                    <input type="email" id="signup-email" class="w-full p-2 px-4 rounded-full border" style="border-color: var(--border-color); background-color: var(--bg-secondary);" required>
                </div>
                <div class="mb-6">
                    <label for="signup-password" class="block font-bold mb-2">Password</label>
                    <input type="password" id="signup-password" class="w-full p-2 px-4 rounded-full border" style="border-color: var(--border-color); background-color: var(--bg-secondary);" required>
                </div>
                <div id="signup-error" class="text-red-500 text-center mb-4 text-sm"></div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" class="btn-cancel px-6 py-2 rounded-full text-gray-700 bg-gray-200 hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="btn-cozy">Sign Up</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- YOUR FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAxCwNySAef9ywfma-7yU16kECg8hhz41Y",
            authDomain: "hearth-1fe4c.firebaseapp.com",
            projectId: "hearth-1fe4c",
            storageBucket: "hearth-1fe4c.appspot.com", // This is needed but we won't use Firebase Storage
            messagingSenderId: "97496518913",
            appId: "1:97496518913:web:84a4ec3d3ad6db22f70b00",
            measurementId: "G-LNMCJCRG8W"
        };
        
        // --- YOUR CLOUDINARY INFO IS NOW INTEGRATED ---
        const CLOUDINARY_CLOUD_NAME = "ddjxihvba";
        const CLOUDINARY_UPLOAD_PRESET = "Hearth";
        // --- END OF CLOUDINARY INFO ---

        const appId = 'hearth-1fe4c';

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- Global State ---
        let allArtworks = [];
        let currentFilter = { category: 'All', tag: null, search: '' };
        let currentUser = null;
        const examplePoems = [
            {
                id: 'ex1', title: 'A Light Exists in Spring', category: 'Written Word', tags: ['nature', 'classic', 'poetry'],
                textContent: `A Light exists in Spring<br>Not present on the Year<br>At any other period —<br>When March is scarcely here...<br><br>- Emily Dickinson`,
                isMature: false, userId: 'System'
            },
            {
                id: 'ex2', title: 'The Road Not Taken', category: 'Written Word', tags: ['life', 'choice', 'poetry'],
                textContent: `Two roads diverged in a yellow wood,<br>And sorry I could not travel both<br>And be one traveler, long I stood<br>And looked down one as far as I could<br>To where it bent in the undergrowth...<br><br>- Robert Frost`,
                isMature: false, userId: 'System'
            }
        ];

        // --- UI Elements ---
        const galleryGrid = document.getElementById('gallery-grid');
        const emptyState = document.getElementById('empty-state');
        const searchBar = document.getElementById('search-bar');
        const startUploadBtn = document.getElementById('start-upload-btn');
        const uploadPrompt = document.getElementById('upload-prompt');
        const appError = document.getElementById('app-error');
        
        // Auth UI
        const loggedInView = document.getElementById('logged-in-view');
        const loggedOutView = document.getElementById('logged-out-view');
        const welcomeMessage = document.getElementById('welcome-message');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginModal = document.getElementById('login-modal');
        const signupModal = document.getElementById('signup-modal');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');

        // Upload Modal UI
        const uploadModal = document.getElementById('upload-modal');
        const uploadForm = document.getElementById('upload-form');
        const categorySelect = document.getElementById('category');
        const editorContent = document.getElementById('editor-content');
        const cancelUploadBtn = document.getElementById('cancel-upload');

        // Detail Modal UI
        const detailModal = document.getElementById('detail-modal');
        const detailModalContent = document.getElementById('detail-modal-content');
        const closeDetailModalBtn = document.getElementById('close-detail-modal');
        
        function showPlaceholders() {
            galleryGrid.innerHTML = Array(8).fill('').map(() => `
                <div class="gallery-item">
                    <div class="placeholder-card w-full h-64 rounded-lg"></div>
                </div>
            `).join('');
        }

        // --- AUTH SYSTEM (FIREBASE) ---
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                updateUIAfterLogin();
            } else {
                currentUser = null;
                updateUIAfterLogout();
            }
        });

        function updateUIAfterLogin() {
            loggedInView.classList.remove('hidden');
            loggedOutView.classList.add('hidden');
            welcomeMessage.textContent = `Welcome, ${currentUser.email}!`;
            startUploadBtn.disabled = false;
            uploadPrompt.classList.add('hidden');
        }

        function updateUIAfterLogout() {
            loggedInView.classList.add('hidden');
            loggedOutView.classList.remove('hidden');
            startUploadBtn.disabled = true;
            uploadPrompt.classList.remove('hidden');
        }

        async function handleSignUp(e) {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const errorEl = document.getElementById('signup-error');
            errorEl.textContent = '';

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                closeModal(signupModal);
            } catch (error) {
                console.error("Firebase SignUp Error:", error.message);
                errorEl.textContent = error.message;
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeModal(loginModal);
            } catch (error) {
                console.error("Firebase Login Error:", error.message);
                errorEl.textContent = error.message;
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Firebase Logout Error:", error.message);
            }
        }

        // --- Art Rendering ---
        function renderArtworks() {
            let artworksToDisplay = [...allArtworks];

            artworksToDisplay.sort((a, b) => {
                const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
                const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
                if (a.userId === 'System') return 1;
                if (b.userId === 'System') return -1;
                return dateB - dateA;
            });
            
            let filteredArtworks = artworksToDisplay.filter(art => {
                const searchLower = currentFilter.search.toLowerCase();
                const titleMatch = art.title.toLowerCase().includes(searchLower);
                const tagMatch = art.tags.some(tag => tag.toLowerCase().includes(searchLower));
                const categoryMatch = art.category.toLowerCase().includes(searchLower);
                
                const categoryFilterMatch = currentFilter.category === 'All' || art.category === currentFilter.category;
                const tagFilterMatch = !currentFilter.tag || art.tags.includes(currentFilter.tag);
                
                return (titleMatch || tagMatch || categoryMatch) && categoryFilterMatch && tagFilterMatch;
            });

            galleryGrid.innerHTML = '';
            const userArtworksExist = filteredArtworks.some(art => art.userId !== 'System');
            emptyState.classList.toggle('hidden', userArtworksExist || filteredArtworks.length > 0);
            
            filteredArtworks.forEach((art, index) => {
                const card = document.createElement('div');
                card.className = 'gallery-item gallery-card fade-in-up';
                card.style.animationDelay = `${index * 50}ms`;

                let mediaContent = '';
                const isPdf = art.imageUrl && art.imageUrl.endsWith('.pdf');

                if (art.isMature) {
                    mediaContent = `<div class="w-full h-48 bg-gray-200 flex flex-col items-center justify-center p-4 text-center"><p class="font-bold">Mature Content</p><p class="text-sm">Click to view</p></div>`;
                } else if (isPdf) {
                     mediaContent = `<div class="w-full h-48 bg-gray-100 flex flex-col items-center justify-center p-4 text-center"><a href="${art.imageUrl}" target="_blank" rel="noopener noreferrer"><i class="fas fa-file-pdf text-4xl mb-2" style="color: var(--text-secondary);"></i><p class="font-semibold">View Music Score</p></a></div>`;
                } else if (art.imageUrl) {
                    mediaContent = `<img src="${art.imageUrl}" alt="${art.title}" class="w-full h-auto object-cover transition-transform duration-300 group-hover:scale-105">`;
                }

                const textPreview = !art.imageUrl && !art.isMature 
                    ? `<div class="prose prose-sm max-h-24 overflow-hidden mb-3" style="color: var(--text-secondary);">${art.textContent}</div>` 
                    : '';

                card.innerHTML = `
                    <div class="cursor-pointer group">
                        ${mediaContent ? `<div class="overflow-hidden">${mediaContent}</div>` : ''}
                        <div class="p-4">
                            <p class="font-bold text-md mb-1 truncate">${art.title}</p>
                            ${textPreview}
                            <p class="text-sm mb-2 capitalize" style="color: var(--text-secondary);">${art.category}</p>
                            <div class="flex flex-wrap gap-1 text-xs">
                                ${art.tags.slice(0, 3).map(tag => `<span class="bg-gray-100 px-2 py-0.5 rounded-full" style="color: var(--text-secondary);">#${tag}</span>`).join('')}
                                ${art.tags.length > 3 ? `<span class="bg-gray-100 px-2 py-0.5 rounded-full" style="color: var(--text-secondary);">+${art.tags.length - 3}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;

                if (!isPdf) { // Don't open modal for PDFs, they open in a new tab
                    card.addEventListener('click', () => openDetailModal(art));
                }
                galleryGrid.appendChild(card);
            });
            
            updateFiltersAndTags();
        }
        
        function updateFiltersAndTags() {
            const allTags = allArtworks.flatMap(art => art.tags);
            const tagCounts = allTags.reduce((acc, tag) => {
                acc[tag] = (acc[tag] || 0) + 1;
                return acc;
            }, {});

            const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            const tagCloud = document.getElementById('tag-cloud');
            tagCloud.innerHTML = sortedTags.map(([tag, count]) => 
                `<button class="tag-btn px-3 py-1 rounded-full text-sm transition ${currentFilter.tag === tag ? 'bg-orange-200 font-bold' : 'bg-gray-100 hover:bg-gray-200'}" data-tag="${tag}" style="color: var(--text-secondary);">#${tag}</button>`
            ).join('');

            document.querySelectorAll('.tag-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (currentFilter.tag === btn.dataset.tag) {
                        currentFilter.tag = null;
                    } else {
                        currentFilter.tag = btn.dataset.tag;
                    }
                    renderArtworks();
                });
            });

             const categoryFilters = document.getElementById('category-filters');
             const categories = ['All', 'Visual Art', 'Photography', 'Musical Score', 'Written Word'];
             categoryFilters.innerHTML = categories.map(cat => 
                `<button class="category-btn px-4 py-2 rounded-full font-semibold transition ${currentFilter.category === cat ? 'bg-orange-500 text-white' : 'bg-white hover:bg-orange-100'}" data-category="${cat}">${cat}</button>`
             ).join('');

             document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentFilter.category = btn.dataset.category;
                    renderArtworks();
                });
             });
        }


        // --- Listen for Artworks from Firebase ---
        function listenForArtworks() {
            const q = query(collection(db, `artifacts/${appId}/public/data/artworks`));
            onSnapshot(q, (snapshot) => {
                appError.classList.add('hidden'); // Hide error on success
                const firestoreArtworks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allArtworks = [...examplePoems, ...firestoreArtworks];
                renderArtworks();
            }, (error) => {
                console.error("Error fetching artworks from Firebase: ", error);
                appError.innerHTML = `Could not load the gallery. This is a Firebase permissions error. <br> <strong>Please go to your Firestore Database -> Rules tab and change the rule to <code class='bg-red-200 p-1 rounded'>allow read, write: if true;</code></strong>`;
                appError.classList.remove('hidden');

                // Still show example poems so the page isn't totally blank
                allArtworks = [...examplePoems];
                renderArtworks();
            });
        }
        

        // --- Modal Logic & Editor ---
        function setupEditor() {
            const toolbar = document.querySelector('.editor-toolbar');
            toolbar.addEventListener('click', (e) => {
                const button = e.target.closest('.toolbar-btn');
                if (!button) return;
                const { command, value } = button.dataset;
                document.execCommand(command, false, value);
                editorContent.focus();
                updateToolbar();
            });

            editorContent.addEventListener('keyup', updateToolbar);
            editorContent.addEventListener('mouseup', updateToolbar);
        }

        function updateToolbar() {
            const buttons = document.querySelectorAll('.toolbar-btn');
            buttons.forEach(button => {
                const command = button.dataset.command;
                if (document.queryCommandState(command)) {
                    button.classList.add('is-active');
                } else {
                    button.classList.remove('is-active');
                }
            });
        }

        function toggleEditor(category) {
            const writeSection = document.getElementById('write-section');
            const fileSection = document.getElementById('file-upload-section');
            if (category === 'Written Word') {
                writeSection.classList.remove('hidden');
                fileSection.classList.add('hidden');
            } else {
                writeSection.classList.add('hidden');
                fileSection.classList.remove('hidden');
            }
        }
        
        categorySelect.addEventListener('change', () => toggleEditor(categorySelect.value));

        function openModal(modal) {
            modal.classList.remove('hidden');
            modal.querySelector('.modal-content').classList.remove('modal-leave');
            modal.querySelector('.modal-content').classList.add('modal-enter');
        }

        function closeModal(modal) {
            modal.querySelector('.modal-content').classList.remove('modal-enter');
            modal.querySelector('.modal-content').classList.add('modal-leave');
            setTimeout(() => {
                modal.classList.add('hidden');
                const form = modal.querySelector('form');
                if (form) form.reset();
                const error = modal.querySelector('[id$="-error"]');
                if (error) error.textContent = '';
            }, 300);
        }

        function openUploadModal() {
            if (!currentUser) {
                openModal(loginModal);
                return;
            }
            openModal(uploadModal);
            toggleEditor(categorySelect.value);
        }
        
        function closeUploadModal() {
            closeModal(uploadModal)
            editorContent.innerHTML = '';
        }

        function openDetailModal(art) {
            let contentHTML = `
                <div class="p-8 pb-0">
                    <h2 class="text-4xl font-bold mb-2">${art.title}</h2>
                    <p class="text-lg mb-4" style="color: var(--text-secondary);">${art.category} &bull; By ${art.userId === 'System' ? 'The Hearth Gallery' : art.userId}</p>
                    <div class="flex flex-wrap gap-2 mb-6">
                        ${art.tags.map(tag => `<span class="bg-gray-200 px-2 py-1 rounded-full text-xs" style="color: var(--text-secondary);">#${tag}</span>`).join('')}
                    </div>
                </div>
            `;
            let mainContent = '';

            if (art.isMature) {
                mainContent = `<div class="w-full h-96 bg-gray-200 flex items-center justify-center text-center">
                                    <div>
                                        <h3 class="text-2xl font-bold">Mature Content</h3>
                                        <button id="reveal-content-btn" class="mt-4 btn-cozy">Click to Reveal</button>
                                    </div>
                                </div>`;
            } else if (art.imageUrl) {
                 mainContent = `<div class="p-8 pt-0"><img src="${art.imageUrl}" alt="${art.title}" class="w-full h-auto max-h-[60vh] object-contain rounded-lg"></div>`;
            } else {
                 mainContent = `<div class="p-8 pt-0 prose max-w-none">${art.textContent}</div>`;
            }
            
            document.getElementById('detail-content-area').innerHTML = contentHTML + mainContent;

            if (art.isMature) {
                const revealBtn = document.getElementById('reveal-content-btn');
                revealBtn.addEventListener('click', () => {
                    let revealedContent = '';
                    if (art.imageUrl) {
                        revealedContent = `<div class="p-8 pt-0"><img src="${art.imageUrl}" alt="${art.title}" class="w-full h-auto max-h-[60vh] object-contain rounded-lg"></div>`;
                    } else {
                        revealedContent = `<div class="p-8 pt-0 prose max-w-none">${art.textContent}</div>`;
                    }
                     revealBtn.parentElement.parentElement.outerHTML = revealedContent;
                }, { once: true });
            }

            detailModal.classList.remove('hidden');
            detailModalContent.classList.remove('modal-leave');
            detailModalContent.classList.add('modal-enter');
        }
        
        function closeDetailModal() {
             closeModal(detailModal);
        }

        // --- UPLOAD TO CLOUDINARY ---
        async function uploadFileToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.secure_url) {
                    return data.secure_url;
                } else {
                    throw new Error('Cloudinary upload failed.');
                }
            } catch (error) {
                console.error("Cloudinary Upload Error:", error);
                return null;
            }
        }


        // --- Form Handling ---
        async function handleUpload(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-upload');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Publishing...';

            const title = document.getElementById('title').value;
            const category = document.getElementById('category').value;
            const tagsInput = document.getElementById('tags').value;
            const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(Boolean) : [];
            const isMatureByUser = document.getElementById('is-mature').checked;
            const fileInput = document.getElementById('artwork-file');
            const textContentHtml = editorContent.innerHTML;
            const errorEl = document.getElementById('upload-error');

            errorEl.textContent = '';
            
            let imageUrl = null;
            let finalIsMature = isMatureByUser;

            if (category !== 'Written Word' && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                if (file.size > 10 * 1024 * 1024) { // 10MB limit for Cloudinary free tier
                    errorEl.textContent = 'File size cannot exceed 10MB.';
                    submitBtn.disabled = false; submitBtn.textContent = 'Publish'; return;
                }
                
                // Upload file to Cloudinary
                imageUrl = await uploadFileToCloudinary(file);
                if (!imageUrl) {
                    errorEl.textContent = 'File upload failed. Please try again.';
                    submitBtn.disabled = false; submitBtn.textContent = 'Publish'; return;
                }

                if (!isMatureByUser && file.type.startsWith('image/')) {
                    if (Math.random() < 0.1) {
                        finalIsMature = true; console.log("AI Simulation: Flagged as mature.");
                    }
                }
            } else if (category === 'Written Word') {
                if (editorContent.textContent.trim().length < 10) {
                     errorEl.textContent = 'Written piece must be at least 10 characters long.';
                     submitBtn.disabled = false; submitBtn.textContent = 'Publish'; return;
                }
            } else {
                errorEl.textContent = 'Please select a file to upload.';
                submitBtn.disabled = false; submitBtn.textContent = 'Publish'; return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/artworks`), {
                    title,
                    category,
                    tags,
                    imageUrl,
                    textContent: textContentHtml,
                    isMature: finalIsMature,
                    createdAt: serverTimestamp(),
                    userId: currentUser.email,
                });
                closeUploadModal();
            } catch (error) {
                console.error("Error adding document to Firebase: ", error);
                errorEl.textContent = 'Could not save artwork. Please try again.';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Publish';
            }
        }
        
        
        // --- Event Listeners ---
        startUploadBtn.addEventListener('click', openUploadModal);
        cancelUploadBtn.addEventListener('click', closeUploadModal);
        closeDetailModalBtn.addEventListener('click', closeDetailModal);
        uploadModal.addEventListener('click', (e) => { if(e.target === uploadModal) closeUploadModal(); });
        detailModal.addEventListener('click', (e) => { if(e.target === detailModal) closeDetailModal(); });
        uploadForm.addEventListener('submit', handleUpload);
        searchBar.addEventListener('input', (e) => {
            currentFilter.search = e.target.value;
            renderArtworks();
        });
        
        // Auth event listeners
        loginBtn.addEventListener('click', () => openModal(loginModal));
        signupBtn.addEventListener('click', () => openModal(signupModal));
        logoutBtn.addEventListener('click', handleLogout);
        loginForm.addEventListener('submit', handleLogin);
        signupForm.addEventListener('submit', handleSignUp);
        document.querySelectorAll('.btn-cancel').forEach(btn => {
            btn.addEventListener('click', () => closeModal(btn.closest('.fixed')));
        });
        loginModal.addEventListener('click', (e) => { if(e.target === loginModal) closeModal(loginModal); });
        signupModal.addEventListener('click', (e) => { if(e.target === signupModal) closeModal(signupModal); });

        
        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (CLOUDINARY_CLOUD_NAME === "YOUR_CLOUD_NAME" || CLOUDINARY_UPLOAD_PRESET === "YOUR_UPLOAD_PRESET") {
                document.body.innerHTML = `<div class="text-center p-8">
                    <h1 class="text-2xl font-bold">Configuration Needed</h1>
                    <p class="mt-2">Please paste your Cloudinary Cloud Name and Upload Preset into the script to enable file uploads.</p>
                </div>`;
                return;
            }
            showPlaceholders();
            listenForArtworks();
            setupEditor();
        });

    </script>
</body>
</html>

