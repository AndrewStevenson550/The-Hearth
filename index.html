<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hearth & Verse</title>
    
    <!-- Google Fonts for the cozy, literary feel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Playfair+Display:wght@500&display=swap" rel="stylesheet">
    <!-- Icon library for search icon and writing tools -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

    <style>
        /* --- üé® Color Palette & Global Styles --- */
        :root {
            --bg-color: #F5F0E8; /* Warm Parchment */
            --text-color: #3D352E; /* Charcoal Grey */
            --accent-primary: #B95C3B; /* Burnt Sienna */
            --accent-secondary: #D4A259; /* Muted Gold */
            --card-bg: #FFFFFF;
            --danger-color: #c94a4a;
            --poetry-color: #6a9c89;
            --art-color: #a37b4c;
            --music-color: #6c7a8f;
        }

        /* Smooth scroll for a calmer experience */
        html {
            scroll-behavior: smooth;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Merriweather', serif;
            margin: 0;
            padding: 0 20px;
            line-height: 1.7;
            overflow-x: hidden; /* Prevents horizontal scrollbar */
            transition: background-color 0.5s ease;
        }

        /* Page wrapper for smooth transitions */
        .page {
            display: none; /* Hide all pages by default */
            animation: fadeInPage 0.7s ease-in-out;
        }

        .page.active {
            display: block; /* Show the active page */
        }

        @keyframes fadeInPage {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- ‚ú® Header & Navigation --- */
        .header {
            text-align: center;
            padding: 40px 20px 20px;
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            color: var(--text-color);
            margin: 0;
            cursor: pointer;
        }

        .header p {
            font-size: 1.1rem;
            color: #6a6056;
            margin-top: 10px;
        }

        .navigation {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 25px;
            border-bottom: 1px solid #e0d9cf;
            padding-bottom: 15px;
        }

        .nav-link {
            font-family: 'Merriweather', serif;
            font-weight: 700;
            color: #8c7f73;
            text-decoration: none;
            font-size: 1rem;
            position: relative;
            padding: 5px 0;
            transition: color 0.3s ease;
            cursor: pointer;
        }

        .nav-link:after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -2px;
            left: 50%;
            background-color: var(--accent-primary);
            transition: all 0.4s ease-out;
        }
        
        .nav-link:hover, .nav-link.active {
            color: var(--accent-primary);
        }

        .nav-link:hover:after, .nav-link.active:after {
            width: 100%;
            left: 0;
        }
        
        /* --- üèÜ Contributions Page --- */
        .contributions-page {
            max-width: 800px;
            margin: 40px auto;
        }
        .contributions-page h2 {
            text-align: center;
            font-family: 'Playfair Display', serif;
            font-size: 2.8rem;
        }
        .leaderboard {
            list-style: none;
            padding: 0;
            margin-top: 40px;
        }
        .leaderboard li {
            display: flex;
            align-items: center;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            font-size: 1.2rem;
        }
        .leaderboard .rank {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--accent-secondary);
            width: 50px;
            text-align: center;
        }
        .leaderboard .author-name {
            font-weight: bold;
            flex-grow: 1;
        }
        .leaderboard .post-count {
            font-size: 1rem;
            color: #8c7f73;
        }

        /* --- üìö The Library: Poem Grid --- */
        .library {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 0;
        }

        /* --- üçÇ Poem Card Styling & Animation --- */
        .poem-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid transparent;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            
            opacity: 0;
            transform: translateY(20px);
            transition: transform 0.4s ease-in-out, 
                        box-shadow 0.4s ease-in-out, 
                        border-left-color 0.4s ease-in-out,
                        opacity 0.6s ease-out;
        }
        
        .poem-card.fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        .poem-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(185, 92, 59, 0.15);
            border-left-color: var(--accent-secondary);
        }
        
        .poem-card-content {
            flex-grow: 1;
        }
        
        .card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }

        .poem-card h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.6rem;
            margin: 0 0 5px 0;
            flex-grow: 1;
        }
        
        .label-container {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        
        .category-label, .mature-label {
            display: inline-block;
            color: white;
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .category-label.poetry { background-color: var(--poetry-color); }
        .category-label.art { background-color: var(--art-color); }
        .category-label.music { background-color: var(--music-color); }
        .mature-label { background-color: var(--danger-color); }


        .poem-card .author {
            font-family: 'Merriweather', serif;
            font-style: italic;
            color: #777;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .poem-card p {
            margin: 0;
            font-size: 0.95rem;
        }
        
        .card-actions {
            margin-top: 20px;
            text-align: right;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }
        .delete-btn:hover {
            color: var(--danger-color);
        }
        
        /* --- üìñ Reading Nook (Single Poem View) --- */
        .reading-nook-container {
            max-width: 700px;
            margin: 40px auto;
            padding: 20px;
        }
        .reading-nook-container .card-header {
            display: block;
            text-align: center;
        }
        .reading-nook-container h2 {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            text-align: center;
        }
        .reading-nook-container h3 {
            font-family: 'Merriweather', serif;
            font-style: italic;
            text-align: center;
            color: #777;
            font-size: 1.2rem;
            margin-top: -15px;
            margin-bottom: 30px;
        }
        .reading-nook-container .post-content {
            font-size: 1.2rem;
            line-height: 2;
            margin-top: 40px;
        }
        .post-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .music-link-container, .pdf-list-container {
            margin-bottom: 20px;
        }
        .pdf-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fdfaf6;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .pdf-item span {
            font-weight: bold;
        }
        .pdf-item-actions a {
            margin-left: 15px;
            color: var(--accent-primary);
            text-decoration: none;
            font-weight: bold;
        }
        .pdf-item-actions a:hover {
            text-decoration: underline;
        }
        .music-link {
            display: block;
            background-color: var(--accent-primary);
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        .music-link:hover {
            background-color: #a34e2f;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(185, 92, 59, 0.3);
        }

        .back-button {
            display: inline-block;
            margin-top: 40px;
            color: var(--accent-primary);
            text-decoration: none;
            font-weight: bold;
        }
        .back-button:hover {
            text-decoration: underline;
        }


        /* --- ‚úçÔ∏è Writing Page --- */
        .writing-nook {
            max-width: 800px;
            margin: 40px auto;
            text-align: center;
        }

        .writing-nook h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
        }
        
        .writing-nook .prompt {
            color: #8c7f73;
            font-style: italic;
            margin-bottom: 30px;
        }
        
        .category-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }
        .category-selector label {
            padding: 10px 20px;
            border: 2px solid #e0d9cf;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .category-selector input {
            display: none;
        }
        .category-selector input:checked + label {
            background-color: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .writer-field {
            display: none;
            text-align: left;
            margin-bottom: 20px;
        }
        .writer-field.active {
            display: block;
        }

        .upload-options {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .file-upload-btn {
            flex: 1;
            padding: 12px 20px;
            background: var(--card-bg);
            border: 2px dashed #e0d9cf;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        .file-upload-btn:hover {
            border-color: var(--accent-secondary);
            background-color: #fdfaf6;
        }
        .file-upload-btn input[type="file"] {
            display: none;
        }

        #art-upload-preview-container {
            text-align: center;
        }
        #art-upload-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 15px;
            border-radius: 4px;
            display: none;
        }
        #pdf-file-list {
            margin-top: 15px;
            font-size: 0.9rem;
            color: #6a6056;
        }
        #pdf-file-list div {
            padding: 5px;
            background-color: #fdfaf6;
            border-radius: 4px;
            margin-bottom: 5px;
        }


        .writing-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #fdfaf6;
            border: 1px solid #e0d9cf;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
        }
        .tool-btn {
            background: none;
            border: 1px solid transparent;
            font-size: 1rem;
            color: var(--text-color);
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            width: 35px;
            height: 35px;
            transition: background-color 0.2s ease, color 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tool-btn:hover {
            background-color: #e0d9cf;
        }
        .tool-btn.active {
            background-color: #d1c9be;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        .color-picker-wrapper {
            --selected-color: var(--text-color); /* Default color for the indicator */
        }
        .color-picker-wrapper::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 6px;
            right: 6px;
            height: 4px;
            background-color: var(--selected-color); /* Use the CSS variable */
            border-radius: 2px;
            transition: background-color 0.2s ease;
        }
        #color-picker {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .poem-editor {
            width: 100%;
            min-height: 40vh;
            border: 1px solid #e0d9cf;
            border-radius: 0 0 8px 8px; /* Match toolbar */
            padding: 20px;
            font-family: 'Merriweather', serif;
            font-size: 1.1rem;
            line-height: 1.8;
            background-color: #fdfaf6;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.04);
            margin-top: -1px; /* Overlap border */
            text-align: left;
        }
        
        .poem-editor:empty:before {
            content: "Your description or verse...";
            color: #aaa;
            pointer-events: none;
        }

        .poem-editor:focus {
            outline: none;
            border-color: var(--accent-secondary);
            box-shadow: 0 0 15px rgba(212, 162, 89, 0.3);
        }
        
        .writing-inputs {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .writing-inputs input {
            flex: 1;
            padding: 12px;
            font-family: 'Merriweather', serif;
            font-size: 1rem;
            border: 1px solid #e0d9cf;
            border-radius: 4px;
        }

        /* --- üîç Search & My Posts Page --- */
        .search-page, .my-posts-page {
            max-width: 1200px;
            margin: 40px auto;
        }

        .search-container {
            position: relative;
            width: 60%;
            max-width: 500px;
            margin: 0 auto 50px auto;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 25px;
            border-radius: 50px;
            border: 2px solid #e0d9cf;
            font-size: 1.1rem;
            font-family: 'Merriweather', serif;
            color: var(--text-color);
            background-color: var(--card-bg);
            transition: all 0.4s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-secondary);
            box-shadow: 0 0 20px rgba(212, 162, 89, 0.4);
            transform: scale(1.02);
        }

        .search-icon {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            color: #aaa;
            transition: color 0.3s ease;
        }
        
        .search-input:focus + .search-icon {
            color: var(--accent-primary);
        }
        
        #search-results, #my-posts-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 30px;
        }
        
        .no-results {
            text-align: center;
            grid-column: 1 / -1;
            font-size: 1.2rem;
            color: #8c7f73;
        }


        /* --- ‚úçÔ∏è Call to Action Button --- */
        .cta-button {
            background-color: var(--accent-primary);
            color: var(--bg-color);
            font-family: 'Merriweather', serif;
            font-weight: 700;
            font-size: 1rem;
            text-decoration: none;
            padding: 15px 30px;
            border: none;
            cursor: pointer;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(185, 92, 59, 0.2);
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            display: inline-block; /* for margin */
            margin-top: 20px;
        }

        .cta-button:hover {
            background-color: #a34e2f;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(185, 92, 59, 0.3);
        }
        
        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(61, 53, 46, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0s 0.4s;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.4s ease;
        }
        .modal-content {
            background: var(--bg-color);
            padding: 40px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: scale(0.9);
            transition: transform 0.4s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-content h2 {
            font-family: 'Playfair Display', serif;
        }
        .modal-content input {
            display: block;
            width: 80%;
            margin: 20px auto;
            padding: 12px;
            font-family: 'Merriweather', serif;
            font-size: 1rem;
        }
        
        /* --- ü¶∂ Footer --- */
        footer {
            text-align: center;
            padding: 40px 20px;
            color: #8c7f73;
            font-size: 0.9rem;
        }

    </style>
</head>
<body>

    <header class="header">
        <h1 id="home-link">Hearth & Verse</h1>
        <p>Your quiet corner for words and warmth.</p>
        <nav class="navigation">
            <a class="nav-link" data-page="library">Library</a>
            <a class="nav-link" data-page="write">Write</a>
            <a class="nav-link" data-page="search">Search</a>
            <a class="nav-link" data-page="contributions">Contributions</a>
            <a class="nav-link" data-page="myposts">My Posts</a>
        </nav>
    </header>

    <main id="library" class="page active"></main>
    <section id="write" class="page"></section>
    <section id="search" class="page"></section>
    <section id="myposts" class="page"></section>
    <section id="reading-nook" class="page"></section>
    <section id="contributions" class="page"></section>
    
    <!-- Modal for setting author name -->
    <div id="author-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Welcome, Creator!</h2>
            <p>Please enter your pen name to continue.</p>
            <input type="text" id="author-name-input" placeholder="Your Pen Name">
            <button id="save-author-btn" class="cta-button">Continue</button>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Hearth & Verse. A quiet place on the web.</p>
    </footer>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // --- DATA & STATE MANAGEMENT ---
            let posts = [];
            let currentUser = null;
            const PROFANITY_LIST = ['examplebadword', 'testprofanity'];
            let uploadedArtData = null;
            let uploadedMusicPDFs = [];
            const navLinks = document.querySelectorAll('.nav-link');

            // --- TEMPLATES ---
            const TEMPLATES = {
                library: `<div class="library"></div>`,
                write: `<div class="writing-nook"><h2>The Scriptorium</h2><p class="prompt">Share your creativity with the world.</p><div class="category-selector"><input type="radio" id="cat-poetry" name="category" value="poetry" checked><label for="cat-poetry">Poetry</label><input type="radio" id="cat-art" name="category" value="art"><label for="cat-art">Art</label><input type="radio" id="cat-music" name="category" value="music"><label for="cat-music">Music</label></div><div id="art-writer" class="writer-field"><p style="text-align:left; font-size: 0.9rem; color: #8c7f73;">Add your artwork and an optional description below:</p><div class="upload-options"><label class="file-upload-btn" for="art-upload-device"><i class="fas fa-upload"></i> Upload from Device</label><input type="file" id="art-upload-device" accept="image/*"><button class="file-upload-btn" id="art-camera-button"><i class="fas fa-camera"></i> Use Camera</button></div><div id="art-upload-preview-container"><img id="art-upload-preview" src="" alt="Image preview"></div></div><div id="music-writer" class="writer-field"><p style="text-align:left; font-size: 0.9rem; color: #8c7f73;">Add your music files and an optional description below:</p><input type="text" id="music-link-input" class="writing-inputs" style="width: 100%; box-sizing: border-box; margin-bottom: 15px;" placeholder="Or, link to your sheet music (e.g., Google Drive, Dropbox)..."><label class="file-upload-btn" for="music-pdf-upload"><i class="fas fa-file-pdf"></i> Upload PDFs (up to 10)</label><input type="file" id="music-pdf-upload" accept=".pdf" multiple><div id="pdf-file-list"></div></div><div id="poetry-writer" class="writer-field active"><p style="text-align:left; font-size: 0.9rem; color: #8c7f73;">Write your verse and a description below:</p><div class="writing-toolbar"><button class="tool-btn" data-command="bold" title="Bold"><i class="fas fa-bold"></i></button><button class="tool-btn" data-command="italic" title="Italic"><i class="fas fa-italic"></i></button><button class="tool-btn" data-command="underline" title="Underline"><i class="fas fa-underline"></i></button><button class="tool-btn" data-command="strikeThrough" title="Strikethrough"><i class="fas fa-strikethrough"></i></button><div class="color-picker-wrapper tool-btn" title="Text Color"><i class="fas fa-palette"></i><input type="color" id="color-picker"></div></div><div id="poem-editor" class="poem-editor" contenteditable="true"></div></div><div class="writing-inputs"><input type="text" id="post-title-input" placeholder="Title of your piece"><input type="text" id="post-author-input" placeholder="Your name" readonly></div><button id="publish-btn" class="cta-button">Publish Your Creation</button></div>`,
                search: `<div class="search-page"><div class="search-container"><input type="text" id="search-input" class="search-input" placeholder="Search for poems, art, music, or authors..."><i class="fas fa-search search-icon"></i></div><div id="search-results"></div></div>`,
                myposts: `<div class="my-posts-page"><h2 style="text-align: center; font-family: 'Playfair Display', serif; font-size: 2.5rem;">My Creations</h2><div id="my-posts-results"></div></div>`,
                readingNook: `<div class="reading-nook-container"></div>`,
                contributions: `<div class="contributions-page"><h2>Top Contributors</h2><ol class="leaderboard"></ol></div>`
            };

            // --- CORE FUNCTIONS ---
            function loadData() {
                posts = JSON.parse(localStorage.getItem('hearthAndVersePosts')) || [];
                currentUser = localStorage.getItem('hearthAndVerseUser');
                
                if (posts.length === 0) {
                    posts = [
                         { id: 0, type: 'poetry', title: "A Welcome to the Hearth", author: "Hearth & Verse", content: "The world outside may whisper low,<br>The autumn air is deep.<br>Come to the fire's gentle glow,<br>A quiet space to keep.<br><br>Let colors spill from brush and hand,<br>Let melodies take flight,<br>Let verses bloom across the land<br>And fill this space with light.<br><br>Your quiet thoughts, your inner art,<br>The stories you hold true,<br>Find shelter here, a place apart,<br>A home for all you do.<br><br>So stay a while and rest your soul,<br>And let your worries cease.<br>Your story helps to make us whole,<br>Now share your inner piece.", media: null, isMature: false },
                    ];
                    savePosts();
                }
            }

            function savePosts() { localStorage.setItem('hearthAndVersePosts', JSON.stringify(posts)); }
            function saveUser(username) {
                currentUser = username;
                localStorage.setItem('hearthAndVerseUser', username);
            }

            // --- UI FUNCTIONS ---
            function createPreview(post) {
                if (post.type === 'art') return post.content ? createTextPreview(post.content) : 'An artwork.';
                if (post.type === 'music') return post.content ? createTextPreview(post.content) : 'A musical piece.';
                return createTextPreview(post.content);
            }

            function createTextPreview(htmlContent) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent.replace(/<br\s*[\/]?>/gi, " ");
                const text = tempDiv.textContent || tempDiv.innerText || "";
                return text.split(' ').slice(0, 20).join(' ') + '...';
            }
            
            function createPostCard(post, options = {}) {
                const { showDeleteButton = false } = options;
                const card = document.createElement('article');
                card.className = 'poem-card';
                card.dataset.postId = post.id;
                
                const matureLabel = post.isMature ? `<span class="mature-label">18+</span>` : '';
                const categoryLabel = `<span class="category-label ${post.type}">${post.type}</span>`;
                const deleteButton = showDeleteButton ? `<div class="card-actions"><button class="delete-btn" data-id="${post.id}"><i class="fas fa-trash"></i> Delete</button></div>` : '';

                card.innerHTML = `<div class="poem-card-content" data-post-id="${post.id}"><div class="card-header"><h2>${post.title}</h2><div class="label-container">${categoryLabel}${matureLabel}</div></div><h3 class="author">By ${post.author}</h3><p>${createPreview(post)}</p></div>${deleteButton}`;
                return card;
            }

            function renderPosts(postList, container, options = {}) {
                if (!container) return;
                container.innerHTML = '';
                if (postList.length === 0) {
                     container.innerHTML = `<p class="no-results">${options.emptyMessage || 'No creations found.'}</p>`;
                     return;
                }
                postList.forEach(post => {
                    container.appendChild(createPostCard(post, options));
                });
            }
            
            let pendingPage = null;

            function showPage(pageId) {
                if ((pageId === 'myposts' || pageId === 'write') && !currentUser) {
                    document.getElementById('author-modal').classList.add('visible');
                    pendingPage = pageId; // Remember which page user wanted to go to
                    return;
                }

                document.querySelectorAll('.page').forEach(p => {
                    p.innerHTML = ''; // Clear content
                    p.classList.remove('active');
                });

                const pageContainer = document.getElementById(pageId);
                if (pageContainer) {
                    pageContainer.innerHTML = TEMPLATES[pageId];
                    pageContainer.classList.add('active');
                    navLinks.forEach(link => link.classList.toggle('active', link.dataset.page === pageId));
                    window.scrollTo(0, 0);
                    initializePage(pageId);
                }
            }

            function initializePage(pageId) {
                if (pageId === 'library') renderPosts(posts, document.querySelector('.library'));
                if (pageId === 'myposts') renderMyPosts();
                if (pageId === 'search') {
                    document.getElementById('search-input').addEventListener('input', handleSearch);
                    handleSearch(); // Render all posts initially
                }
                if (pageId === 'contributions') renderLeaderboard();
                if (pageId === 'write') initializeWritePage();
            }

            function openPost(postId) {
                const post = posts.find(p => p.id == postId);
                if (!post) return;
                
                let mediaHTML = '';
                if(post.type === 'art') {
                    mediaHTML = `<img src="${post.media.url}" alt="${post.title}">`;
                } else if(post.type === 'music') {
                     if (post.media.type === 'link') {
                        mediaHTML = `<div class="music-link-container"><a href="${post.media.url}" target="_blank" rel="noopener noreferrer" class="music-link">View Sheet Music</a></div>`;
                     } else if (post.media.type === 'pdf') {
                        let pdfLinks = post.media.files.map(file => 
                            `<div class="pdf-item"><span>${file.name}</span><div class="pdf-item-actions"><a href="${file.data}" target="_blank" rel="noopener noreferrer">View</a><a href="${file.data}" download="${file.name}">Download</a></div></div>`
                        ).join('');
                        mediaHTML = `<div class="pdf-list-container">${pdfLinks}</div>`;
                     }
                }

                const matureLabel = post.isMature ? `<span class="mature-label">18+</span>` : '';
                const categoryLabel = `<span class="category-label ${post.type}">${post.type}</span>`;
                const descriptionHTML = post.content ? `<div class="post-description">${post.content}</div>` : '';

                showPage('reading-nook');
                const container = document.querySelector('.reading-nook-container');
                container.innerHTML = `<a href="#" class="back-button" data-page="library">&larr; Back to Library</a><div class="card-header"><h2>${post.title}</h2><div class="label-container">${categoryLabel}${matureLabel}</div></div><h3>By ${post.author}</h3><div class="post-content">${mediaHTML}${descriptionHTML}</div>`;
            }

            // --- PAGE-SPECIFIC RENDER FUNCTIONS ---
            function renderMyPosts() {
                const myPosts = posts.filter(p => p.author === currentUser);
                renderPosts(myPosts, document.getElementById('my-posts-results'), { showDeleteButton: true, emptyMessage: "You haven't published any creations yet." });
            }
            function handleSearch() {
                const searchInput = document.getElementById('search-input');
                if (!searchInput) return;
                const query = searchInput.value.toLowerCase().trim();
                const filteredPosts = posts.filter(post => {
                    const textContent = (new DOMParser().parseFromString(post.content, "text/html")).documentElement.textContent;
                    return post.title.toLowerCase().includes(query) || post.author.toLowerCase().includes(query) || textContent.toLowerCase().includes(query) || post.type.toLowerCase().includes(query);
                });
                renderPosts(filteredPosts, document.getElementById('search-results'));
            }
            function renderLeaderboard() {
                const contributions = posts.reduce((acc, post) => {
                    acc[post.author] = (acc[post.author] || 0) + 1;
                    return acc;
                }, {});

                const sortedContributors = Object.entries(contributions).sort((a, b) => b[1] - a[1]);

                const leaderboardList = document.querySelector('.leaderboard');
                leaderboardList.innerHTML = sortedContributors.map(([author, count], index) => `
                    <li>
                        <span class="rank">#${index + 1}</span>
                        <span class="author-name">${author}</span>
                        <span class="post-count">${count} post${count > 1 ? 's' : ''}</span>
                    </li>
                `).join('');
            }
            
            // --- EVENT LISTENERS ---
            document.querySelector('.navigation').addEventListener('click', e => {
                if (e.target.matches('.nav-link, .nav-link *')) {
                    const link = e.target.closest('.nav-link');
                    e.preventDefault();
                    showPage(link.dataset.page);
                }
            });

            document.getElementById('home-link').addEventListener('click', () => showPage('library'));
            
            document.body.addEventListener('click', function(e) {
                if (e.target.matches('.auth-switch a')) {
                    e.preventDefault();
                    showPage(e.target.dataset.page);
                }
                const cardContent = e.target.closest('.poem-card-content');
                if (cardContent) openPost(cardContent.dataset.postId);
                const backButton = e.target.closest('.back-button');
                if (backButton) { e.preventDefault(); showPage(backButton.dataset.page); }
                const deleteButton = e.target.closest('.delete-btn');
                if(deleteButton) {
                    if (confirm("Are you sure you want to permanently delete this creation?")) {
                        posts = posts.filter(p => p.id !== parseInt(deleteButton.dataset.id, 10));
                        savePosts();
                        renderMyPosts();
                    }
                }
            });
            
            document.getElementById('save-author-btn').addEventListener('click', () => {
                const authorNameInput = document.getElementById('author-name-input');
                const name = authorNameInput.value.trim();
                if (name) {
                    saveUser(name);
                    document.getElementById('author-modal').classList.remove('visible');
                    if (pendingPage) {
                        showPage(pendingPage);
                        pendingPage = null;
                    }
                } else {
                    alert('Please enter a name.');
                }
            });

            // --- WRITE PAGE LOGIC ---
            function initializeWritePage() {
                const authorInput = document.getElementById('post-author-input');
                if (currentUser) {
                    authorInput.value = currentUser;
                    authorInput.readOnly = true;
                } else {
                    // This case should not be reached due to page guard, but as a fallback:
                    authorInput.readOnly = false;
                }

                document.querySelectorAll('input[name="category"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        const selectedCategory = document.querySelector('input[name="category"]:checked').value;
                        document.querySelectorAll('.writer-field').forEach(field => {
                            field.classList.toggle('active', field.id.includes(selectedCategory));
                        });
                    });
                });
                
                const artUploadDevice = document.getElementById('art-upload-device');
                function handleArtFile(file) {
                    if(file) {
                        const reader = new FileReader();
                        reader.onload = e => {
                            uploadedArtData = e.target.result;
                            const artPreview = document.getElementById('art-upload-preview');
                            artPreview.src = uploadedArtData;
                            artPreview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                }
                artUploadDevice.addEventListener('change', e => handleArtFile(e.target.files[0]));
                // document.getElementById('art-camera-button').addEventListener('click', startCamera);
                
                document.getElementById('music-pdf-upload').addEventListener('change', e => {
                    const files = e.target.files;
                    if (files.length > 10) { alert("Max 10 files."); e.target.value = ''; return; }
                    uploadedMusicPDFs = [];
                    const fileListEl = document.getElementById('pdf-file-list');
                    fileListEl.innerHTML = '';
                    Array.from(files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = re => {
                            uploadedMusicPDFs.push({ name: file.name, data: re.target.result });
                            fileListEl.innerHTML += `<div>${file.name}</div>`;
                        };
                        reader.readAsDataURL(file);
                    });
                });
                
                const editor = document.getElementById('poem-editor');
                document.querySelector('.writing-toolbar').addEventListener('click', e => {
                    const button = e.target.closest('.tool-btn');
                    if (button && button.dataset.command) { document.execCommand(button.dataset.command, false, null); editor.focus(); }
                });
                document.addEventListener('selectionchange', () => {
                    if (document.activeElement === editor) {
                        document.querySelectorAll('.writing-toolbar .tool-btn').forEach(b => b.classList.toggle('active', document.queryCommandState(b.dataset.command)));
                    }
                });
                document.getElementById('color-picker').addEventListener('input', e => {
                    document.execCommand('foreColor', false, e.target.value);
                    e.target.closest('.color-picker-wrapper').style.setProperty('--selected-color', e.target.value);
                    editor.focus();
                });

                document.getElementById('publish-btn').addEventListener('click', () => {
                    const title = document.getElementById('post-title-input').value.trim();
                    const author = authorInput.value.trim();
                    const description = editor.innerHTML.trim();
                    const textContent = editor.innerText.trim();
                    const type = document.querySelector('input[name="category"]:checked').value;
                    if (!title || !author) { alert("Please provide a title and your name."); return; }
                    
                    if (!currentUser) {
                        saveUser(author);
                    }

                    const newPost = { id: Date.now(), title, author, type, content: description, media: null, isMature: false }; // Simplified for now

                    if (type === 'art') {
                        if (!uploadedArtData) { alert("Please select an image file."); return; }
                        newPost.media = { type: 'image', url: uploadedArtData };
                    } else if (type === 'music') {
                        const musicLink = document.getElementById('music-link-input').value.trim();
                        if (!musicLink && uploadedMusicPDFs.length === 0) { alert("Please provide a link or upload PDFs."); return; }
                        newPost.media = musicLink ? { type: 'link', url: musicLink } : { type: 'pdf', files: uploadedMusicPDFs };
                    } else if (description === '' || description === '<br>') {
                        alert("Please write your poem."); return;
                    }
                    
                    posts.push(newPost);
                    savePosts();
                    showPage('library');
                });
            }

            // --- INITIALIZATION ---
            loadData();
            showPage('library');
            navLinks.forEach(l => l.classList.add('visible'));

        });
    </script>

</body>
</html>

